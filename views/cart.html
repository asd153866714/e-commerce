<html>

<head>
	<meta charset="utf-8">
	<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	<meta name="description" content="">
	<meta name="author" content="">

	<title>購物車</title>

	<!-- Bootstrap core CSS -->
	<link href="vendor/bootstrap/css/bootstrap.min.css" rel="stylesheet">

	<!-- Custom styles for this template -->
	<link href="css/cart.css" rel="stylesheet">

	<!-- Bootstrap core JavaScript -->
	<script src="vendor/jquery/jquery.min.js"></script>
	<script src="vendor/bootstrap/js/bootstrap.bundle.min.js"></script>

</head>

<!-- 判斷登入狀態 -->
<% if (userid == undefined){ %>
<body onload="alert_login()">
<% } else { %>
<body onload="loadCart()" 
<% } %> 
	<!-- Navigation -->
	<%- include('header.html') -%>
	
	<div class="container" style="margin-top: 80px;">
		<% for(var i=0; i < c_data.length; i++){ %>
		<div class="col-lg-12 card" id="<%= c_data[i].name %>">
			<div class="card-body">
				<div class="row">

					<div class="col-12 col-md-2">
						<strong><%= c_data[i].name %></strong>
					</div>
					<div class="col-3 col-md-2 offset-10 offset-md-0" style="float:right;">
						<h6><strong><%= c_data[i].price %></strong></h6>
					</div>
					<div class="col-6 col-md-6">
						<input type="number" id="amount" class="<%= c_data[i].name %>"
							value="<%= c_data[i].amount %>">
					</div>
					<div class="col-3 col-md-2  offset-3 offset-md-0">
						<a href="#"><input type="button" class="<%= c_data[i].name %>" value="刪除"></a>
					</div>
				</div>
			</div>
		</div>
		<% } %>
		
		<div class="row">
			<div class="col-12 col-md-6 offset-md-6">
				<div class="card">
					<div class="card-body">
						<p>
							<a href="/">繼續購物</a>
						</p>
						<div class="row">
							<div class="col-6">
								<p>總計 :</p>
							</div>
							<div class="col-6 text-right">
								<strong id='total'>0</strong>
							</div>
						</div>
						<div>
							<button type="button" class="btn btn-success" style="width: 100%;"
								onclick="clearCart()">結帳</button>
						</div>
					</div>
				</div>
			</div>
		</div>
	</div>

	<script>

		function loadCart() {
			Count()
			amountChange()
		}

		// 偵測修改數量事件，和刪除商品事件
		function amountChange() {

			const am = document.querySelectorAll("input[type = 'number']").forEach(item => {
				item.addEventListener('change', event => {
					console.log(item.className)
					console.log("amount", event.target.value)
					Count()

					// 用 AJAX 傳回變動後的產品數量給 Server
					let p_data = JSON.stringify({ "name": item.className, "amount": event.target.value })
					var r = new XMLHttpRequest();
					r.open("POST", "updateProductAmount", true);
					r.onreadystatechange = function () {
						if (r.readyState != 4 || r.status != 200) return;
					};
					r.send(p_data);
				})
			})

			// 偵測刪除商品事件
			const rm = document.querySelectorAll("input[type = 'button']").forEach(item => {
				item.addEventListener('click', event => {
					// 用 AJAX 傳回要刪除的商品給 Server
					let p_data = JSON.stringify({ "name": item.className })
					var r = new XMLHttpRequest();
					r.open("POST", "removeCartItem", true);
					r.onreadystatechange = function () {
						if (r.readyState != 4 || r.status != 200) return;
					};
					r.send(p_data);

					// 清除該列內容的動態效果
					console.log("removeCartItem", item.className)
					document.getElementById(item.className).innerHTML = ''
					console.log("rm test")
					Count()
				})
			})
		}

		// 計算總金額
		function Count() {
			let sum = 0
			let price = document.querySelectorAll("h6 > strong")
			let amount = document.querySelectorAll("input[type = number]")

			for (i = 0; i < price.length; i++) {
				p = Number(price[i].innerHTML)
				a = Number(amount[i].value)
				sum += p * a
			}
			document.querySelector("#total").innerHTML = sum;
		}

		// 清除購物車
		function clearCart() {
			localStorage.clear()
			location.href = '/'
		}

		// 登入提醒視窗
		function alert_login() {
			alert('請先登入')
			location.href = '/login'
		}
	</script>
</body>
</html>